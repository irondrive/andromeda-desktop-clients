#!/bin/bash -e

mkdir build 2> /dev/null || true; cd build

cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..
PLATFORMS="native unix32 unix64 win32A win32W win64"
LOGFILE=cppcheck/analyze_stderr.log

for PLAT in $PLATFORMS; do
    rm $LOGFILE 2> /dev/null || true
    echo "scanning platform $PLAT..."
    mkdir -p cppcheck/$PLAT 2> /dev/null || true

    cppcheck --project=compile_commands.json \
        --cppcheck-build-dir=cppcheck/$PLAT \
        --quiet --std=c++17 --platform=$PLAT \
        --suppress="*:*_deps/*" \
        --suppress=missingIncludeSystem \
        --suppress=unreadVariable \
        --suppress=unusedFunction \
        --suppress=unmatchedSuppression \
        --enable=style,performance,portability,information $@ 2> $LOGFILE

    if [ -s $LOGFILE ]; then
        echo "found errors with target $PLAT!"
        cat $LOGFILE
        exit 1
    fi
done; rm $LOGFILE
